version: '3.8'

services:
  # -------------------------
  # 1. Ollama (à¹€à¸œà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰)
  # -------------------------
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_storage:/root/.ollama
      - ./ollama/entrypoint.sh:/entrypoint.sh
    entrypoint: [ "/bin/bash", "-c", "tr -d '\\r' < /entrypoint.sh | bash" ]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    networks:
      - ai-net

  # -------------------------
  # 2. GPUStack (Server + Worker) âœ… à¹à¸à¹‰à¹à¸¥à¹‰à¸§
  # -------------------------
  gpustack:
    image: gpustack/gpustack:latest
    ports:
      - "10101:80"
    volumes:
      - gpustack_data:/var/lib/gpustack
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # âœ… à¸¥à¹‡à¸­à¸ Token à¹„à¸§à¹‰
      - GPUSTACK_TOKEN=mysecrettoken123
      # âŒ à¸¥à¸šà¸šà¸£à¸£à¸—à¸±à¸” GPUSTACK_SERVER_URL à¸­à¸­à¸! (à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸¡à¸±à¸™à¸£à¸¹à¹‰à¸•à¸±à¸§à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Server)
      
      # âœ… à¸•à¸±à¹‰à¸‡à¸£à¸«à¸±à¸ª Admin
      - GPUSTACK_ADMIN_PASSWORD=Qwerty@1234
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    ipc: host
    networks:
      - ai-net

  # -------------------------
  # 3. Backend
  # -------------------------
  backend:
    build:
      context: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/src:/app/src
    environment:
      - OLLAMA_URL=http://ollama:11434
      - GUARD_ENGINE=guardrails_ai
      # ðŸ‘‡ Backend à¸¢à¸±à¸‡à¸•à¹‰à¸­à¸‡à¸Šà¸µà¹‰à¹„à¸›à¸—à¸µà¹ˆ gpustack à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡ (à¸–à¸¹à¸à¹à¸¥à¹‰à¸§)
      - GPUSTACK_URL=http://gpustack:80/v1
      - GPUSTACK_API_KEY=mysecrettoken123
    depends_on:
      - ollama
      - gpustack
    networks:
      - ai-net

  # -------------------------
  # 4. Frontend
  # -------------------------
  frontend:
    build:
      context: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend/src:/app/src
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend
    networks:
      - ai-net

volumes:
  ollama_storage:
  gpustack_data:

networks:
  ai-net:
    driver: bridge