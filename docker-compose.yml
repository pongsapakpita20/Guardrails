version: '3.8'

services:
  # -------------------------
  # 1. Ollama (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Local) ü¶ô
  # -------------------------
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_storage:/root/.ollama
      # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ entrypoint script ‡∏Å‡πá mount ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
      - ./backend/src/llm/entrypoint.sh:/entrypoint.sh
    # ‡∏ñ‡πâ‡∏≤ script ‡πÉ‡∏ô windows ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á line ending (\r) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏Å‡πâ
    entrypoint: [ "/bin/bash", "-c", "tr -d '\\r' < /entrypoint.sh | bash" ]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    networks:
      - dev-net

  # -------------------------
  # 2. Backend (App ‡∏´‡∏•‡∏±‡∏Å) ‚öôÔ∏è
  # -------------------------
  backend:
    build:
      context: ./backend
      args:
        # Token ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏™‡πà‡∏°‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ)
        GUARDRAILS_TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJpSlNlN3ZhNExSbUpxbkZOZUV6VEt0eEZHY1dXdFVuTyIsImFwaUtleUlkIjoiMzEzZGFjNmQtZDE3Yy00OGZkLTllNTItZjdhZDM1N2RjN2U2Iiwic2NvcGUiOiJyZWFkOnBhY2thZ2VzIiwicGVybWlzc2lvbnMiOlsidGhyZWF0X3Rlc3Rlcl9pbnZpdGU6dHJ1ZSJdLCJpYXQiOjE3NzA4NzA2NjcsImV4cCI6NDkyNDQ3MDY2N30.DOijp5oC0pZZFhmrRkXGw00GlNV3dnWfXOgbLtBIofs
    ports:
      - "8000:8000"
    volumes:
      - ./backend/src:/app/src
    environment:
      # ‡∏ï‡πà‡∏≠ Local Ollama
      - OLLAMA_URL=http://ollama:11434
      
      - GUARD_ENGINE=guardrails_ai
      # ‡πÉ‡∏™‡πà URL (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° /v1-openai ‡∏´‡∏£‡∏∑‡∏≠ /v1 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏≤‡∏ï‡∏±‡πâ‡∏á)
      - GPUSTACK_URL=http://IP_ADDRESS_‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:PORT/v1-openai
      
      # ‡πÉ‡∏™‡πà API Key 
      - GPUSTACK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
      
    networks:
      - dev-net

  # -------------------------
  # 3. Frontend (‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö) üíª
  # -------------------------
  frontend:
    build:
      context: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend/src:/app/src
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend
    networks:
      - dev-net

volumes:
  ollama_storage:

networks:
  dev-net:
    driver: bridge